<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>TURN Open Relay PoC (Browser Sender)</title>
</head>
<body>
  <h2>TURN Open Relay PoC - Browser Sender</h2>
  <p>1. Paste the offer from the receiver.py script below.<br>
     2. Click "Create Answer".<br>
     3. Copy the answer to the receiver terminal.<br>
     4. Click "Send Message" to prove relay.</p>
  <textarea id="offer" cols="100" rows="10" placeholder="Paste offer here"></textarea><br>
  <button onclick="createAnswer()">Create Answer</button><br><br>
  <textarea id="answer" cols="100" rows="10" placeholder="Copy this answer to receiver"></textarea><br>
  <input id="msg" value="Hello from browser! TURN is an open relay."><br>
  <button onclick="sendMessage()" id="sendBtn" disabled>Send Message</button>
  <pre id="log"></pre>
<script>
let pc, channel;

async function createAnswer() {
  document.getElementById('log').textContent = "Creating peer connection...";
  let offer = JSON.parse(document.getElementById('offer').value);
  pc = new RTCPeerConnection({
    iceServers: [{
      urls: 'turn:test.kmp.sn:3478?transport=udp',
      username: '1754040322:@tchiboor:test.kmp.sn',
      credential: 'y41rZbvm7t6Wk+BvPIKnrd2uAmY='
    }]
  });

  pc.ondatachannel = event => {
    channel = event.channel;
    channel.onopen = () => {
      document.getElementById('log').textContent += "\n[+] DataChannel open!";
      document.getElementById('sendBtn').disabled = false;
    };
    channel.onclose = () => {
      document.getElementById('log').textContent += "\n[-] DataChannel closed.";
    };
    channel.onmessage = e => {
      document.getElementById('log').textContent += "\n[Browser RECEIVED]: " + e.data;
    };
  };

  await pc.setRemoteDescription(offer);
  let answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  // Wait for ICE gathering
  await new Promise(resolve => {
    if (pc.iceGatheringState === "complete") return resolve();
    pc.onicegatheringstatechange = () => {
      if (pc.iceGatheringState === "complete") resolve();
    };
  });

  document.getElementById('answer').value = JSON.stringify(pc.localDescription);
  document.getElementById('log').textContent += "\n[+] Answer created. Paste this to receiver.py.";
}

function sendMessage() {
  let msg = document.getElementById('msg').value;
  if (channel && channel.readyState === "open") {
    channel.send(msg);
    document.getElementById('log').textContent += "\n[Sent] " + msg;
  } else {
    document.getElementById('log').textContent += "\n[-] Channel not open!";
  }
}
</script>
</body>
</html>
